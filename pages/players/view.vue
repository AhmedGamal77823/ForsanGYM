<template>
  <div id="View" >
    <page-title title="Player Info" icon="fa fa-user" />
    <div class="row align-items-center flex-md-row-reverse">
      <div class="col-md-3 mb-3 mb-md-0">
        <div class="img mx-auto text-center">
          <img
            class="rounded-circle"
            :src="'localhost:3000/'+player.photo"
            alt=""
          />
        </div>
        <div class="d-flex actions  text-center my1 mx-auto w-100" >
          <button type="button" class="btn btn-warning mx-auto w-100" data-toggle="modal"
                  data-target="#staticBackdrop" v-on:focusin="initPage">Edit</button>
          <edit :playerId='player.id'  />
          <!-- End of popup window -->
        </div>

        <div class="d-flex actions  text-center my-1 mx-auto w-100" >
          <button type="button" class="btn btn-outline-primary mx-auto w-100" v-on:click="freeze()" v-on:focusin="initPage" v-if="player.invited <=0">Freeze</button>
          <button type="button" class="btn btn-outline-primary mx-auto w-100" v-else disabled>Freeze</button>
        </div>

        <div class="d-flex actions  text-center my-1 mx-auto w-100" >
          <button type="button" class="btn btn-outline-secondary mx-auto w-100" v-on:focusin="initPage" v-if="player.freeze===0" v-on:click="addInvite()">Invite Friend</button>
          <button type="button" class="btn btn-outline-secondary mx-auto w-100" v-else disabled>Invite Friend</button>
        </div>

      </div>
      <div class="col-md-9 text-break">
        <div class="tile">
          <div class="tile-title-w-btn">
            <h2 data-toggle="dropdown" class="title">
              <span class="mdi mdi-account-circle"></span>
              {{player.name}}
            </h2>
          </div>
          <div class="tile-body">

            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-id-card"></span> ID
                </h5>
              </div>

              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{player.id}}</h5>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-phone"></span> Phone Number
                </h5>
              </div>

              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{player.phoneNumber}}</h5>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-road"></span> Plan
                </h5>
              </div>

              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{player.subscription.plan.name}}</h5>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-calendar"></span> BeginDate
                </h5>
              </div>
              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{ player.subscription.beginDate }}</h5>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-calendar-remove-outline"></span> EndDate
                </h5>
              </div>
              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{player.subscription.endDate}}</h5>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-weight-kilogram"></span> Weight
                </h5>
              </div>
              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{player.weights[player.weights.length-1].weight}}</h5>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-human-male-height-variant"></span> Height
                </h5>
              </div>
              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{player.height}}</h5>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-dumbbell"></span> Training Plan
                </h5>
              </div>
              <div class="col-md-7">
                <h5 class="mb-0 font-weight-normal" v-if="player.trainingPlan">
                  {{player.trainingPlan}}
                  <br />
                </h5>
                <h5 class="mb-0 font-weight-normal" v-else>
                  {{player.name}} has no training plan.
                  <br />
                </h5>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-food-apple"></span>Diet
                </h5>
              </div>

              <div class="col-md-7">
                <h5 class="mb-0 font-weight-normal" v-if="player.dietPlan">
                  {{player.dietPlan}}
                  <br />
                </h5>
                <h5 class="mb-0 font-weight-normal" v-else>
                  {{player.name}} has no diet plan.
                  <br />
                </h5>
              </div>
            </div>

            <div class="row mb-2">
              <div class="col-md-3">
                <h5 class="mb-0">
                  <span class="mb-0 mdi mdi-message"></span> left Invitation
                </h5>
              </div>
              <div class="col-md-9">
                <h5 class="mb-0 font-weight-normal">{{player.subscription.plan.numberOfExceptions - player.invited}}</h5>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
    <div class="row ">
      <div class="col-md-7">
        <WeightTable :player="player"/>
      </div>

    </div>
  </div>
</template>

<script>
import PageTitle from "../../components/layout/pageTitle";
import Edit from '../../components/players/edit.vue';
import WeightTable from "../../components/players/weightTable";
import moment from "moment/moment";
import Swal from "sweetalert2";

export default {
  components: {WeightTable, PageTitle, Edit },
  data(){
    return{
      player: {},

    }
  },
  methods:{
    initPage: function (){
      console.log("init worked ")
      const id = this.$route.params.id

      this.player = Object.assign({},this.$store.state.players.find(player=>{
        return player.id === id
      }))



    },

    freeze: function (){
      this.$axios.$get('player/freeze/'+this.player.id).then(()=>{
        this.$axios.$post('subscription/updateDate/'+this.player.id, {
          beginDate:this.player.subscription.beginDate,
          endDate:moment(this.player.subscription.endDate).add(this.player.subscription.plan.numberOfExceptions ,'day').format("YYYY-MM-DD")
        }).then(()=>{
          this.$store.commit('editPlayer', {
            ...this.player,
            subscription:{
              ...this.player.subscription,
              endDate: moment(this.player.subscription.endDate).add(this.player.subscription.plan.numberOfExceptions ,'day').format("YYYY-MM-DD")
            }
          })
          this.$swal.fire({
            title:"Player has been Frozen",
            icon:"success",
            iconColor:"#316aff"
          })
        })
      }).catch(err=>{
        this.$swal.fire({
          title:`Freezing player Failed`,
          icon:"error",
          text:err.response.data.message
        })
      })
    },

    addInvite: function (){
      this.$swal.fire({
        title:`How many invitations you want to add ? `,
        icon:"question",
        input:'text',
        inputPlaceholder: `Enter a number from 1 to ${this.player.subscription.plan.numberOfExceptions - this.player.invited} `,
        showCancelButton:true
      }).then(res=>{
        if(!res.isDismissed){
          if (isNaN(Number(res.value)) || res.value === "") {
            // Validate the value is a number :D
            Swal.fire({
              icon: "error",
              title: "Weight must be a number"
            })
          }else{
            this.$axios.$post('player/inviteFriend/'+this.player.id, {
              numberOfInvitedPlayers: Number(res.value)
            }).then(()=>{
              this.$store.commit('editPlayer', {...this.player,
              invited:this.player.invited + Number(res.value) })
            }).catch(err=>{
              this.$swal.fire({
                title:`Inviting a friend Faild`,
                icon:"error",
                text:err.response.data.message
              })
            })
          }
        }
      })
    },

    },
  created() {
    this.initPage()
  }
};
</script>

<style>
</style>
